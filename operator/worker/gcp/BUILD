load("@io_bazel_rules_docker//container:container.bzl", "container_image", "container_push")

package(default_visibility = ["//visibility:public"])

container_image(
    name = "worker_app_mp_gcp_image_dev",
    base = "@java_base//image",
    cmd = [
        "WorkerRunner_deploy.jar",
        "--client_config_env",
        "GCP",
        "--job_client",
        "GCP",
        "--blob_storage_client",
        "GCP_CS_CLIENT",
        "--decryption_key_service",
        "GCP_KMS_MULTI_PARTY_DECRYPTION_KEY_SERVICE",
        "--primary_encryption_key_service_base_url",
        "https://encryptionkeys-dese5nieua-uc.a.run.app/v1alpha",
        "--secondary_encryption_key_service_base_url",
        "https://encryptionkeys-pw7byubg3q-uc.a.run.app/v1alpha",
        "--coordinator_a_kms_key",
        "gcp-kms://projects/adhcloud-tp1/locations/us/keyRings/keyring1/cryptoKeys/kek1",
        "--coordinator_b_kms_key",
        "gcp-kms://projects/adhcloud-tp2/locations/us/keyRings/keyring1/cryptoKeys/kek1",
        "--coordinator_a_wip_provider",
        "projects/1045723567663/locations/global/workloadIdentityPools/aggregate-service-in-tee/providers/attestation-service",
        "--coordinator_a_sa",
        "verifiedadtechuser@adhcloud-tp1.iam.gserviceaccount.com",
        "--coordinator_b_wip_provider",
        "projects/413684760801/locations/global/workloadIdentityPools/aggregate-service-in-tee/providers/attestation-service",
        "--coordinator_b_sa",
        "verifiedadtechuser@adhcloud-tp2.iam.gserviceaccount.com",
        "--param_client",
        "GCP",
        "--metric_client",
        "GCP",
        "--lifecycle_client",
        "GCP",
    ],
    entrypoint = [
        "/usr/bin/java",
        "-XX:MaxRAMPercentage=66.0",
        "-jar",
    ],
    files = ["//java/com/google/scp/operator/worker:WorkerRunnerDeploy"],
    labels = {"tee.launch_policy.allow_cmd_override": "false"},
)

container_push(
    name = "worker_app_mp_gcp_image_dev_publish",
    format = "Docker",
    image = ":worker_app_mp_gcp_image_dev",
    registry = "us-docker.pkg.dev",
    repository = "admcloud-scp/docker-repo-dev/worker_app_mp_gcp",
    tag = "dev",
)

container_image(
    name = "worker_app_mp_gcp_image_staging",
    base = "@java_base//image",
    cmd = [
        "WorkerRunner_deploy.jar",
        "--client_config_env",
        "GCP",
        "--job_client",
        "GCP",
        "--blob_storage_client",
        "GCP_CS_CLIENT",
        "--decryption_key_service",
        "GCP_KMS_MULTI_PARTY_DECRYPTION_KEY_SERVICE",
        "--primary_encryption_key_service_base_url",
        "https://privatekeyservice-staging-a.gcp.admcstesting.dev/v1alpha",
        "--secondary_encryption_key_service_base_url",
        "https://privatekeyservice-staging-b.gcp.admcstesting.dev/v1alpha",
        "--primary_encryption_key_service_cloudfunction_url",
        "https://staging-a-us-central1-encryption-key-service-clou-n6opw6gfda-uc.a.run.app",
        "--secondary_encryption_key_service_cloudfunction_url",
        "https://staging-b-us-central1-encryption-key-service-clou-xypihwhdwq-uc.a.run.app",
        "--coordinator_a_kms_key",
        "gcp-kms://projects/admcloud-coordinator1/locations/us/keyRings/staging-a_key_encryption_ring/cryptoKeys/staging-a_key_encryption_key",
        "--coordinator_b_kms_key",
        "gcp-kms://projects/admcloud-coordinator2/locations/us/keyRings/staging-b_key_encryption_ring/cryptoKeys/staging-b_key_encryption_key",
        "--coordinator_a_wip_provider",
        "projects/849763871756/locations/global/workloadIdentityPools/staging-a-opwip/providers/staging-a-opwip-pvdr",
        "--coordinator_a_sa",
        "staging-a-opverifiedusr@admcloud-coordinator1.iam.gserviceaccount.com",
        "--coordinator_b_wip_provider",
        "projects/483398766744/locations/global/workloadIdentityPools/staging-b-opwip/providers/staging-b-opwip-pvdr",
        "--coordinator_b_sa",
        "staging-b-opverifiedusr@admcloud-coordinator2.iam.gserviceaccount.com",
        "--param_client",
        "GCP",
        "--metric_client",
        "GCP",
        "--lifecycle_client",
        "GCP",
    ],
    entrypoint = [
        "/usr/bin/java",
        "-XX:MaxRAMPercentage=66.0",
        "-jar",
    ],
    files = ["//java/com/google/scp/operator/worker:WorkerRunnerDeploy"],
    labels = {"tee.launch_policy.allow_cmd_override": "false"},
)

container_push(
    name = "worker_app_mp_gcp_image_staging_publish",
    format = "Docker",
    image = ":worker_app_mp_gcp_image_staging",
    registry = "us-docker.pkg.dev",
    repository = "admcloud-scp/docker-repo-dev/worker_app_mp_gcp",
    tag = "staging",
)

container_image(
    name = "worker_app_mp_gcp_image_postsubmit",
    base = "@java_base//image",
    cmd = [
        "WorkerRunner_deploy.jar",
        "--client_config_env",
        "GCP",
        "--job_client",
        "GCP",
        "--blob_storage_client",
        "GCP_CS_CLIENT",
        "--decryption_key_service",
        "GCP_KMS_MULTI_PARTY_DECRYPTION_KEY_SERVICE",
        "--primary_encryption_key_service_base_url",
        "https://privatekeyservice-postsubmit-a.gcp.admcstesting.dev/v1alpha",
        "--secondary_encryption_key_service_base_url",
        "https://privatekeyservice-postsubmit-b.gcp.admcstesting.dev/v1alpha",
        "--primary_encryption_key_service_cloudfunction_url",
        "https://postsubmit-a-us-central1-encryption-key-service-c-n6opw6gfda-uc.a.run.app",
        "--secondary_encryption_key_service_cloudfunction_url",
        "https://postsubmit-b-us-central1-encryption-key-service-c-xypihwhdwq-uc.a.run.app",
        "--coordinator_a_kms_key",
        "gcp-kms://projects/admcloud-coordinator1/locations/us/keyRings/postsubmit-a_key_encryption_ring/cryptoKeys/postsubmit-a_key_encryption_key",
        "--coordinator_b_kms_key",
        "gcp-kms://projects/admcloud-coordinator2/locations/us/keyRings/postsubmit-b_key_encryption_ring/cryptoKeys/postsubmit-b_key_encryption_key",
        "--coordinator_a_wip_provider",
        "projects/849763871756/locations/global/workloadIdentityPools/postsubmit-a-opwip/providers/postsubmit-a-opwip-pvdr",
        "--coordinator_a_sa",
        "postsubmit-a-opverifiedusr@admcloud-coordinator1.iam.gserviceaccount.com",
        "--coordinator_b_wip_provider",
        "projects/483398766744/locations/global/workloadIdentityPools/postsubmit-b-opwip/providers/postsubmit-b-opwip-pvdr",
        "--coordinator_b_sa",
        "postsubmit-b-opverifiedusr@admcloud-coordinator2.iam.gserviceaccount.com",
        "--param_client",
        "GCP",
        "--metric_client",
        "GCP",
        "--lifecycle_client",
        "GCP",
        "--pbs_client",
        "GCP",
        "--coordinator_a_privacy_budgeting_service_base_url",
        "https://pbs-postsubmit-a.gcp.admcstesting.dev/v1",
        "--coordinator_a_privacy_budgeting_service_auth_endpoint",
        "https://postsubmit-a-us-central1-pbs-auth-cloudfunction-n6opw6gfda-uc.a.run.app",
        "--coordinator_b_privacy_budgeting_service_base_url",
        "https://pbs-postsubmit-b.gcp.admcstesting.dev/v1",
        "--coordinator_b_privacy_budgeting_service_auth_endpoint",
        "https://postsubmit-b-us-central1-pbs-auth-cloudfunction-xypihwhdwq-uc.a.run.app",
        "--notification_client",
        "GCP",
    ],
    entrypoint = [
        "/usr/bin/java",
        "-XX:MaxRAMPercentage=66.0",
        "-jar",
    ],
    files = ["//java/com/google/scp/operator/worker:WorkerRunnerDeploy"],
    labels = {"tee.launch_policy.allow_cmd_override": "false"},
)

container_push(
    name = "worker_app_mp_gcp_image_postsubmit_publish",
    format = "Docker",
    image = ":worker_app_mp_gcp_image_postsubmit",
    registry = "us-docker.pkg.dev",
    repository = "admcloud-scp/docker-repo-dev/worker_app_mp_gcp",
    tag = "postsubmit",
)

container_image(
    name = "worker_app_mp_gcp_image_perf",
    base = "@java_base//image",
    cmd = [
        "WorkerRunner_deploy.jar",
        "--client_config_env",
        "GCP",
        "--job_client",
        "GCP",
        "--blob_storage_client",
        "GCP_CS_CLIENT",
        "--decryption_key_service",
        "GCP_KMS_MULTI_PARTY_DECRYPTION_KEY_SERVICE",
        "--primary_encryption_key_service_base_url",
        "https://privatekeyservice-staging-a.gcp.admcstesting.dev/v1alpha",
        "--secondary_encryption_key_service_base_url",
        "https://privatekeyservice-staging-b.gcp.admcstesting.dev/v1alpha",
        "--primary_encryption_key_service_cloudfunction_url",
        "https://staging-a-us-central1-encryption-key-service-clou-n6opw6gfda-uc.a.run.app",
        "--secondary_encryption_key_service_cloudfunction_url",
        "https://staging-b-us-central1-encryption-key-service-clou-xypihwhdwq-uc.a.run.app",
        "--coordinator_a_kms_key",
        "gcp-kms://projects/admcloud-coordinator1/locations/us/keyRings/staging-a_key_encryption_ring/cryptoKeys/staging-a_key_encryption_key",
        "--coordinator_b_kms_key",
        "gcp-kms://projects/admcloud-coordinator2/locations/us/keyRings/staging-b_key_encryption_ring/cryptoKeys/staging-b_key_encryption_key",
        "--coordinator_a_wip_provider",
        "projects/849763871756/locations/global/workloadIdentityPools/staging-a-opwip/providers/staging-a-opwip-pvdr",
        "--coordinator_a_sa",
        "staging-a-opverifiedusr@admcloud-coordinator1.iam.gserviceaccount.com",
        "--coordinator_b_wip_provider",
        "projects/483398766744/locations/global/workloadIdentityPools/staging-b-opwip/providers/staging-b-opwip-pvdr",
        "--coordinator_b_sa",
        "staging-b-opverifiedusr@admcloud-coordinator2.iam.gserviceaccount.com",
        "--param_client",
        "GCP",
        "--metric_client",
        "GCP",
        "--lifecycle_client",
        "GCP",
        "--stopwatch_bucket_name",
        "scp-e2e-testing",
        "--stopwatch_key_name",
        "perf/operator/gcp/mp/stopwatches",
        "--stopwatch_exporter",
        "CLOUD",
        "--benchmark",
    ],
    entrypoint = [
        "/usr/bin/java",
        "-XX:MaxRAMPercentage=66.0",
        "-jar",
    ],
    files = ["//java/com/google/scp/operator/worker:WorkerRunnerDeploy"],
    labels = {"tee.launch_policy.allow_cmd_override": "false"},
)

container_push(
    name = "worker_app_mp_gcp_image_perf_publish",
    format = "Docker",
    image = ":worker_app_mp_gcp_image_perf",
    registry = "us-docker.pkg.dev",
    repository = "admcloud-scp/docker-repo-dev/worker_app_mp_gcp",
    tag = "perf",
)

container_image(
    name = "worker_app_mp_gcp_image_release_tar",
    base = "@java_base//image",
    cmd = [
        "WorkerRunner_deploy.jar",
        "--client_config_env",
        "GCP",
        "--job_client",
        "GCP",
        "--blob_storage_client",
        "GCP_CS_CLIENT",
        "--decryption_key_service",
        "GCP_KMS_MULTI_PARTY_DECRYPTION_KEY_SERVICE",
        "--primary_encryption_key_service_base_url",
        "http://34.120.70.91/v1alpha",
        "--secondary_encryption_key_service_base_url",
        "http://34.160.25.196/v1alpha",
        "--primary_encryption_key_service_cloudfunction_url",
        "https://release-a-us-central1-encryption-key-service-clou-n6opw6gfda-uc.a.run.app",
        "--secondary_encryption_key_service_cloudfunction_url",
        "https://release-b-us-central1-encryption-key-service-clou-xypihwhdwq-uc.a.run.app",
        "--coordinator_a_kms_key",
        "gcp-kms://projects/admcloud-coordinator1/locations/us/keyRings/release-a_key_encryption_ring/cryptoKeys/release-a_key_encryption_key",
        "--coordinator_b_kms_key",
        "gcp-kms://projects/admcloud-coordinator2/locations/us/keyRings/release-b_key_encryption_ring/cryptoKeys/release-b_key_encryption_key",
        "--coordinator_a_wip_provider",
        "projects/849763871756/locations/global/workloadIdentityPools/release-a-opwip/providers/release-a-opwip-pvdr",
        "--coordinator_a_sa",
        "release-a-opverifiedusr@admcloud-coordinator1.iam.gserviceaccount.com",
        "--coordinator_b_wip_provider",
        "projects/483398766744/locations/global/workloadIdentityPools/release-b-opwip/providers/release-b-opwip-pvdr",
        "--coordinator_b_sa",
        "release-b-opverifiedusr@admcloud-coordinator2.iam.gserviceaccount.com",
        "--param_client",
        "GCP",
        "--metric_client",
        "GCP",
        "--lifecycle_client",
        "GCP",
        "--notification_client",
        "GCP",
    ],
    entrypoint = [
        "/usr/bin/java",
        "-XX:MaxRAMPercentage=66.0",
        "-jar",
    ],
    files = ["//java/com/google/scp/operator/worker:WorkerRunnerDeploy"],
    labels = {"tee.launch_policy.allow_cmd_override": "false"},
)

container_push(
    name = "worker_app_mp_gcp_image_release_tar_publish",
    format = "Docker",
    image = ":worker_app_mp_gcp_image_release_tar",
    registry = "us-docker.pkg.dev",
    repository = "admcloud-scp/docker-repo-dev/worker_app_mp_gcp",
    tag = "release",
)
